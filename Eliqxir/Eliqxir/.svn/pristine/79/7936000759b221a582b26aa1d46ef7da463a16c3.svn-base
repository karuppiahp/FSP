package com.eliqxir.driver;

import java.util.ArrayList;
import java.util.List;
import org.apache.http.NameValuePair;
import org.apache.http.message.BasicNameValuePair;
import org.json.JSONException;
import org.json.JSONObject;
import android.app.Activity;
import android.app.Dialog;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Bundle;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.view.Window;
import android.widget.BaseAdapter;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.TextView;
import com.eliqxir.R;
import com.eliqxir.support.ServerResponse;
import com.eliqxir.support.ServerResponse.RequestType;
import com.eliqxir.utils.Constant;
import com.eliqxir.utils.UrlGenerator;
import com.eliqxir.utils.Utils;

public class OrderDeliveredActivity extends Activity implements OnClickListener {

	public void onStop() {
		if (Constant.isDriverAvailable.equals("notAvailable")) {
			finish();
		}

		super.onStop();

	}

	ArrayList<String> quantity = new ArrayList<String>();
	ArrayList<String> orderItmName = new ArrayList<String>();
	ArrayList<String> orderItmSize = new ArrayList<String>();
	ArrayList<String> orderItmValue = new ArrayList<String>();
	ImageView imageForDriverOrderCallStore, imageForDriverOrderCallCustomer;
	ImageButton backImg, cartBtn, btnSlideMenu,btnForAssignDriver;
	TextView textForHeader, textForDriverOrderTimeIn,
			textForDriverOrderOrderNo, textForDriverOrderAddress,
			textForDriverOrderPhone, textForDriverOrderName;
	ListView listOfOrders;
	String orderId, time, address, customer_phone, store_phone, total,
			customer_name, store_name, product_name, size, qty, price,
			product_id;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		Utils.trackError(getApplicationContext());
		requestWindowFeature(Window.FEATURE_NO_TITLE);
		setContentView(R.layout.driver_order_delivered);

		quantity.clear();
		orderItmName.clear();
		orderItmSize.clear();
		orderItmValue.clear();
		orderId = getIntent().getExtras().getString("orderId");
		time = getIntent().getExtras().getString("time");
		address = getIntent().getExtras().getString("address");
		customer_phone = getIntent().getExtras().getString("customer_phone");
		store_phone = getIntent().getExtras().getString("store_phone");
		total = getIntent().getExtras().getString("total");
		customer_name = getIntent().getExtras().getString("customer_name");
		store_name = getIntent().getExtras().getString("store_name");
		product_name = getIntent().getExtras().getString("product_name");
		size = getIntent().getExtras().getString("size");
		qty = getIntent().getExtras().getString("qty");
		price = getIntent().getExtras().getString("price");
		product_id = getIntent().getExtras().getString("product_id");
		quantity.add(qty);
		orderItmName.add(product_name);
		orderItmValue.add(price);
		orderItmSize.add(size);
		textForDriverOrderTimeIn = (TextView) findViewById(R.id.textForDriverOrderTimeIn);
		textForDriverOrderTimeIn.setText(time);
		textForDriverOrderOrderNo = (TextView) findViewById(R.id.textForDriverOrderOrderNo);
		textForDriverOrderOrderNo.setText(orderId);
		textForDriverOrderAddress = (TextView) findViewById(R.id.textForDriverOrderAddress);
		textForDriverOrderAddress.setText(address);
		textForDriverOrderPhone = (TextView) findViewById(R.id.textForDriverOrderPhone);
		textForDriverOrderPhone.setText(customer_phone);
		textForDriverOrderName = (TextView) findViewById(R.id.textForDriverOrderName);
		imageForDriverOrderCallCustomer = (ImageView) findViewById(R.id.imageForDriverOrderCallCustomer);
		imageForDriverOrderCallStore = (ImageView) findViewById(R.id.imageForDriverOrderCallStore);
		imageForDriverOrderCallStore.setOnClickListener(this);
		imageForDriverOrderCallCustomer.setOnClickListener(this);
		textForDriverOrderName.setText(customer_name);
		btnSlideMenu = (ImageButton) findViewById(R.id.btnSliderMenu);
		backImg = (ImageButton) findViewById(R.id.backBtn);
		cartBtn = (ImageButton) findViewById(R.id.cartBtn);
		btnForAssignDriver= (ImageButton) findViewById(R.id.btnForAssignDriver);
		btnForAssignDriver.setOnClickListener(this);
		textForHeader = (TextView) findViewById(R.id.textForHeader);
		listOfOrders = (ListView) findViewById(R.id.listForOrderAssign);
		btnSlideMenu.setVisibility(View.GONE);
		cartBtn.setVisibility(View.GONE);
		backImg.setVisibility(View.VISIBLE);
		backImg.setOnClickListener(this);
		textForHeader.setText("ORDER");

		listOfOrders.setAdapter(new OrderItems(getBaseContext()));
	}

	public class OrderItems extends BaseAdapter {
		Context context;

		public OrderItems(Context context1) {
			// TODO Auto-generated constructor stub
			context = context1;
		}

		@Override
		public int getCount() {
			// TODO Auto-generated method stub
			return orderItmName.size();
		}

		@Override
		public Object getItem(int position) {
			// TODO Auto-generated method stub
			return null;
		}

		@Override
		public long getItemId(int position) {
			// TODO Auto-generated method stub
			return 0;
		}

		@Override
		public View getView(int position, View convertView, ViewGroup parent) {
			// TODO Auto-generated method stub
			View v = convertView;
			LayoutInflater inflater = LayoutInflater.from(context);
			v = inflater.inflate(R.layout.list_of_order_items, null);
			TextView textForQuantity = (TextView) v
					.findViewById(R.id.textForQuantities);
			TextView textForOrderItem = (TextView) v
					.findViewById(R.id.textForOrderItemName);
			TextView textForOrderItemPacks = (TextView) v
					.findViewById(R.id.textForOrderItemPacks);
			TextView textForOrderAmnt = (TextView) v
					.findViewById(R.id.textForAmount);

			textForQuantity.setText(quantity.get(position));
			textForOrderItem.setText(orderItmName.get(position));
			textForOrderItemPacks.setText(orderItmSize.get(position));
			textForOrderAmnt.setText(orderItmValue.get(position));
			return v;
		}

	}

	@Override
	public void onClick(View v) {
		// TODO Auto-generated method stub
		switch (v.getId()) {
		case R.id.backBtn:
			finish();
			break;
		case R.id.imageForDriverOrderCallCustomer:
			Intent callIntent = new Intent(Intent.ACTION_DIAL);
			callIntent.setData(Uri.parse("tel:"+customer_phone));
			startActivity(callIntent);
			break;
		case R.id.imageForDriverOrderCallStore:
			Intent callIntent1 = new Intent(Intent.ACTION_DIAL);
			callIntent1.setData(Uri.parse("tel:"+store_phone));
			startActivity(callIntent1);
			break;
		case R.id.btnForAssignDriver:
			boolean isOnline = Utils.isOnline();
			Log.e("isOnline", isOnline + "");
			if (isOnline) {
				new MarkOrderDelivered().execute();

			}
			else
			{
				Utils.ShowAlert(OrderDeliveredActivity.this, Constant.networkDisconected);
			}
			break;
		}
	}
	public class MarkOrderDelivered extends AsyncTask<Void, Void, Void> {
		ProgressDialog dialog;
		String status = "", error = "", orderType;
		JSONObject jsonObj;

		

		@Override
		protected void onPostExecute(Void result) {

			if (dialog.isShowing()) {
				dialog.dismiss();
			}

			try {

				if (status.equals("1")) {
					
					showDeliverAlert();
				} else {
					btnForAssignDriver.setBackgroundResource(R.drawable.mark_as_deleivered_btn);
					Utils.ShowAlert(OrderDeliveredActivity.this, error);
				}
			} catch (Exception e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}

		}

		

		@Override
		protected void onPreExecute() {
			super.onPreExecute();
			this.dialog = new ProgressDialog(OrderDeliveredActivity.this);
			this.dialog.setMessage("Loading..");
			this.dialog.show();
			this.dialog.setCancelable(false);

		}

		@Override
		protected Void doInBackground(Void... params) {
			List<NameValuePair> nameValuePairs = new ArrayList<NameValuePair>(1);
			nameValuePairs.add(new BasicNameValuePair("order_id", orderId));
			Log.e("orderId in orderspecific page", orderId);
			
				jsonObj = new ServerResponse(
						UrlGenerator.vendorMarkDelivered())
						.getJSONObjectfromURL(RequestType.POST, nameValuePairs);
			
			Log.e("order Delivered", jsonObj + "");
			try {
				if (jsonObj != null) {
					status = jsonObj.getString("status");
					if (status.equals("0")) {
						error = jsonObj.getString("Error");
					} else if (status.equals("1")) {
					}
				}
			} catch (JSONException e) {
				e.printStackTrace();
			}
			return null;
		}

	}
	private void showDeliverAlert() {
		// TODO Auto-generated method stub
		 final Dialog dialog = new Dialog(OrderDeliveredActivity.this);
		 dialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
		 dialog.setContentView(R.layout.closed_order_popup);
		 // dialog.getWindow().setBackgroundDrawable(
		 // new ColorDrawable(android.graphics.Color.WHITE));
		 dialog.setCanceledOnTouchOutside(false);
		 TextView textOk = (TextView) dialog
		 .findViewById(R.id.txtForClosedOk);
		 textOk.setOnClickListener(new OnClickListener() {
		
		 @Override
		 public void onClick(View arg0) {
		 // TODO Auto-generated method stub
		 dialog.dismiss();
		 startActivity(new Intent(OrderDeliveredActivity.this,OrdersActivity.class));
		 }
		 });
		 dialog.show();
	}
}
